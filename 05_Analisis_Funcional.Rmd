---
title: "Análisis Funcional: GO, KEGG y GSEA"
author: "JoseHidalgo"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    theme: united
    code_folding: show
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = TRUE, warning = TRUE, fig.width = 10, fig.height = 8)
project_dir <- "C:/Users/10935/Documents/Proyecto_Adenocarcinoma_RNAseq"
knitr::opts_knit$set(root.dir = project_dir)
```

# 1. Cargar Librerías
```{r load-libraries, message=FALSE, warning=FALSE}
library(clusterProfiler)
library(enrichplot)
library(org.Hs.eg.db)
library(AnnotationDbi)
library(tidyverse)
library(ggplot2)

cat("clusterProfiler version:", as.character(packageVersion("clusterProfiler")), "\n")
cat("org.Hs.eg.db version:", as.character(packageVersion("org.Hs.eg.db")), "\n")
```

# 2. Cargar DEGs
```{r load-degs}
# Cargar resultados de DESeq2
degs <- read.csv("06_differential_expression/DEGs_significant.csv")
all_results <- read.csv("06_differential_expression/DESeq2_all_results.csv")

cat("Total DEGs:", nrow(degs), "\n")
cat("Upregulated:", sum(degs$log2FoldChange > 0), "\n")
cat("Downregulated:", sum(degs$log2FoldChange < 0), "\n")
```

# 3. Convertir IDs: Ensembl a ENTREZ
```{r convert-ids}
# Eliminar sufijos de versión (.X) de Ensembl IDs
degs$gene_id_clean <- sub("\\..*", "", degs$gene_id)
all_results$gene_id_clean <- sub("\\..*", "", all_results$gene_id)

# Convertir Ensembl a ENTREZ para DEGs
degs$entrez <- mapIds(
  org.Hs.eg.db,
  keys = degs$gene_id_clean,
  column = "ENTREZID",
  keytype = "ENSEMBL",
  multiVals = "first"
)

# Convertir Ensembl a ENTREZ para ALL RESULTS
all_results$entrez <- mapIds(
  org.Hs.eg.db,
  keys = all_results$gene_id_clean,
  column = "ENTREZID",
  keytype = "ENSEMBL",
  multiVals = "first"
)

# Filtrar genes sin ENTREZ ID
degs_with_entrez <- degs %>% filter(!is.na(entrez))

cat("\nDEGs con ENTREZ ID:", nrow(degs_with_entrez), "\n")
cat("DEGs sin ENTREZ ID:", sum(is.na(degs$entrez)), "\n")
```

# 4. Gene Ontology (GO) - Biological Process

**Para ejecutar:** `eval=FALSE` -> `eval=TRUE`
```{r go-bp, eval=FALSE}
cat("Ejecutando enriquecimiento GO (Biological Process)...\n")

ego_bp <- enrichGO(
  gene = degs_with_entrez$entrez,
  OrgDb = org.Hs.eg.db,
  ont = "BP",
  pAdjustMethod = "BH",
  pvalueCutoff = 0.05,
  qvalueCutoff = 0.2,
  readable = TRUE
)

# Guardar resultados
saveRDS(ego_bp, "07_functional_analysis/GO_BP_results.rds")
write.csv(as.data.frame(ego_bp), "07_functional_analysis/GO_BP_results.csv", row.names = FALSE)

cat("Terminos GO-BP enriquecidos:", nrow(ego_bp), "\n")
```

# 5. Gene Ontology (GO) - Molecular Function
```{r go-mf, eval=FALSE}
cat("Ejecutando enriquecimiento GO (Molecular Function)...\n")

ego_mf <- enrichGO(
  gene = degs_with_entrez$entrez,
  OrgDb = org.Hs.eg.db,
  ont = "MF",
  pAdjustMethod = "BH",
  pvalueCutoff = 0.05,
  qvalueCutoff = 0.2,
  readable = TRUE
)

saveRDS(ego_mf, "07_functional_analysis/GO_MF_results.rds")
write.csv(as.data.frame(ego_mf), "07_functional_analysis/GO_MF_results.csv", row.names = FALSE)

cat("Terminos GO-MF enriquecidos:", nrow(ego_mf), "\n")
```

# 6. Gene Ontology (GO) - Cellular Component
```{r go-cc, eval=FALSE}
cat("Ejecutando enriquecimiento GO (Cellular Component)...\n")

ego_cc <- enrichGO(
  gene = degs_with_entrez$entrez,
  OrgDb = org.Hs.eg.db,
  ont = "CC",
  pAdjustMethod = "BH",
  pvalueCutoff = 0.05,
  qvalueCutoff = 0.2,
  readable = TRUE
)

saveRDS(ego_cc, "07_functional_analysis/GO_CC_results.rds")
write.csv(as.data.frame(ego_cc), "07_functional_analysis/GO_CC_results.csv", row.names = FALSE)

cat("Terminos GO-CC enriquecidos:", nrow(ego_cc), "\n")
```

# 7. KEGG Pathway Enrichment
```{r kegg, eval=FALSE}
cat("Ejecutando enriquecimiento KEGG...\n")

# Configurar opciones de descarga
options(download.file.method = "libcurl")
options(timeout = 300)

kegg <- enrichKEGG(
  gene = degs_with_entrez$entrez,
  organism = "hsa",
  pAdjustMethod = "BH",
  pvalueCutoff = 0.05,
  qvalueCutoff = 0.2
)

# Agregar nombres de genes
kegg <- setReadable(kegg, OrgDb = org.Hs.eg.db, keyType = "ENTREZID")

saveRDS(kegg, "07_functional_analysis/KEGG_results.rds")
write.csv(as.data.frame(kegg), "07_functional_analysis/KEGG_results.csv", row.names = FALSE)

cat("Vias KEGG enriquecidas:", nrow(kegg), "\n")
```

# 8. Cargar Resultados
```{r load-results}
# Verificar y cargar resultados
if (file.exists("07_functional_analysis/GO_BP_results.rds")) {
  ego_bp <- readRDS("07_functional_analysis/GO_BP_results.rds")
  cat("GO-BP terms:", nrow(ego_bp), "\n")
}

if (file.exists("07_functional_analysis/GO_MF_results.rds")) {
  ego_mf <- readRDS("07_functional_analysis/GO_MF_results.rds")
  cat("GO-MF terms:", nrow(ego_mf), "\n")
}

if (file.exists("07_functional_analysis/GO_CC_results.rds")) {
  ego_cc <- readRDS("07_functional_analysis/GO_CC_results.rds")
  cat("GO-CC terms:", nrow(ego_cc), "\n")
}

if (file.exists("07_functional_analysis/KEGG_results.rds")) {
  kegg <- readRDS("07_functional_analysis/KEGG_results.rds")
  cat("KEGG pathways:", nrow(kegg), "\n")
}
```

# 9. Visualizaciones: GO-BP
```{r plot-go-bp, fig.width=12, fig.height=8}
if (exists("ego_bp") && nrow(ego_bp) > 0) {
  # Dot plot
  p1 <- dotplot(ego_bp, showCategory = 20) +
    ggtitle("GO Biological Process: Top 20")
  print(p1)
  ggsave("08_figures_tables/GO_BP_dotplot.png", p1, width = 12, height = 8, dpi = 300)
  
  # Bar plot
  p2 <- barplot(ego_bp, showCategory = 15) +
    ggtitle("GO Biological Process: Top 15")
  print(p2)
  ggsave("08_figures_tables/GO_BP_barplot.png", p2, width = 10, height = 8, dpi = 300)
}
```

# 10. Visualizaciones: KEGG
```{r plot-kegg, fig.width=12, fig.height=8}
if (exists("kegg") && nrow(kegg) > 0) {
  # Dot plot
  p3 <- dotplot(kegg, showCategory = 20) +
    ggtitle("KEGG Pathways: Top 20")
  print(p3)
  ggsave("08_figures_tables/KEGG_dotplot.png", p3, width = 12, height = 8, dpi = 300)
  
  # Bar plot
  p4 <- barplot(kegg, showCategory = 15) +
    ggtitle("KEGG Pathways: Top 15")
  print(p4)
  ggsave("08_figures_tables/KEGG_barplot.png", p4, width = 10, height = 8, dpi = 300)
}
```

# 11. GSEA (Gene Set Enrichment Analysis)
```{r gsea, eval=FALSE}
cat("Ejecutando GSEA...\n")

# Preparar ranked gene list (todos los genes, no solo DEGs)
all_genes <- all_results %>%
  filter(!is.na(entrez)) %>%
  filter(!is.na(log2FoldChange)) %>%
  # Eliminar duplicados: quedarse con el de mayor |log2FC|
  group_by(entrez) %>%
  slice_max(abs(log2FoldChange), n = 1, with_ties = FALSE) %>%
  ungroup() %>%
  arrange(desc(log2FoldChange))

# Crear lista rankeada
gene_list <- all_genes$log2FoldChange
names(gene_list) <- all_genes$entrez

# Verificar que no hay duplicados
cat("Genes en lista rankeada:", length(gene_list), "\n")
cat("Genes unicos:", length(unique(names(gene_list))), "\n")

# GSEA GO
gsea_go <- gseGO(
  geneList = gene_list,
  OrgDb = org.Hs.eg.db,
  ont = "BP",
  pvalueCutoff = 0.05,
  pAdjustMethod = "BH",
  verbose = FALSE
)

saveRDS(gsea_go, "07_functional_analysis/GSEA_GO_results.rds")
write.csv(as.data.frame(gsea_go), "07_functional_analysis/GSEA_GO_results.csv", row.names = FALSE)

# GSEA KEGG
gsea_kegg <- gseKEGG(
  geneList = gene_list,
  organism = "hsa",
  pvalueCutoff = 0.05,
  pAdjustMethod = "BH",
  verbose = FALSE
)

gsea_kegg <- setReadable(gsea_kegg, OrgDb = org.Hs.eg.db, keyType = "ENTREZID")

saveRDS(gsea_kegg, "07_functional_analysis/GSEA_KEGG_results.rds")
write.csv(as.data.frame(gsea_kegg), "07_functional_analysis/GSEA_KEGG_results.csv", row.names = FALSE)

cat("GSEA GO terms:", nrow(gsea_go), "\n")
cat("GSEA KEGG pathways:", nrow(gsea_kegg), "\n")
```

# 12. Visualizaciones: GSEA
```{r plot-gsea, fig.width=12, fig.height=8}
if (file.exists("07_functional_analysis/GSEA_GO_results.rds")) {
  gsea_go <- readRDS("07_functional_analysis/GSEA_GO_results.rds")
  
  if (nrow(gsea_go) > 0) {
    # Dot plot
    p5 <- dotplot(gsea_go, showCategory = 20, split = ".sign") +
      facet_grid(~.sign) +
      ggtitle("GSEA: GO Biological Process")
    print(p5)
    ggsave("08_figures_tables/GSEA_GO_dotplot.png", p5, width = 14, height = 8, dpi = 300)
  }
}

if (file.exists("07_functional_analysis/GSEA_KEGG_results.rds")) {
  gsea_kegg <- readRDS("07_functional_analysis/GSEA_KEGG_results.rds")
  
  if (nrow(gsea_kegg) > 0) {
    # Dot plot
    p6 <- dotplot(gsea_kegg, showCategory = 20, split = ".sign") +
      facet_grid(~.sign) +
      ggtitle("GSEA: KEGG Pathways")
    print(p6)
    ggsave("08_figures_tables/GSEA_KEGG_dotplot.png", p6, width = 14, height = 8, dpi = 300)
  }
}
```

# 13. Resumen
```{r summary}
cat("  RESUMEN DE ANALISIS FUNCIONAL\n")

cat("DEGs analizados:", nrow(degs_with_entrez), "\n\n")

if (exists("ego_bp")) cat("GO-BP terms:", nrow(ego_bp), "\n")
if (exists("ego_mf")) cat("GO-MF terms:", nrow(ego_mf), "\n")
if (exists("ego_cc")) cat("GO-CC terms:", nrow(ego_cc), "\n")
if (exists("kegg")) cat("KEGG pathways:", nrow(kegg), "\n")

if (file.exists("07_functional_analysis/GSEA_GO_results.rds")) {
  gsea_go <- readRDS("07_functional_analysis/GSEA_GO_results.rds")
  cat("GSEA GO terms:", nrow(gsea_go), "\n")
}

if (file.exists("07_functional_analysis/GSEA_KEGG_results.rds")) {
  gsea_kegg <- readRDS("07_functional_analysis/GSEA_KEGG_results.rds")
  cat("GSEA KEGG pathways:", nrow(gsea_kegg), "\n")
}

cat("\nArchivos generados:\n")
cat("  - GO_BP_results.csv\n")
cat("  - GO_MF_results.csv\n")
cat("  - GO_CC_results.csv\n")
cat("  - KEGG_results.csv\n")
cat("  - GSEA_GO_results.csv\n")
cat("  - GSEA_KEGG_results.csv\n")
cat("  + Graficos en 08_figures_tables/\n")
```

```{r session-info}
sessionInfo()
```